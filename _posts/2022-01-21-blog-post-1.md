---
layout: post
title: Blog Post 1
---



2022-01-21

## 1. Create a Database

First we import the packages we need.

```python
import sqlite3
from plotly import express as px
from plotly.io import write_html
```

Then we create our database and read in the files.

```python
#create a database in current directory called temps.db
conn = sqlite3.connect("temps.db") 
#We clean up the data using the function prepare_df
def prepare_df(df):
    df = df.set_index(keys=["ID", "Year"])
    #stack up everything except for the indexes chosen so that the months fall in a single column
    df = df.stack()
    df = df.reset_index()
    #rename the columns
    df = df.rename(columns = {"level_2"  : "Month" , 0 : "Temp"})
    #keep only the last two characters in the column "Months" so that we can turn a word into numbers
    df["Month"] = df["Month"].str[5:].astype(int)
    #turn the data in "Temp" into degrees
    df["Temp"]  = df["Temp"] / 100
    return(df)
#we read in the data one by one
df_iter = pd.read_csv("temps.csv", chunksize = 100000)
for df in df_iter:
    df = prepare_df(df)
    df.to_sql("temperatures", conn, if_exists = "append", index = False)

countries = pd.read_csv("countries.csv")
countries = countries.rename(columns = {"Name"  : "Country" })
countries.to_sql("countries", conn, if_exists = "replace", index = False)

stations = pd.read_csv("station-metadata.csv")
stations["FIPS 10-4"] = stations["ID"].str[0:2]
stations.to_sql("stations", conn, if_exists = "replace", index = False)
```

Next we display our dataset to make sure we read in the right thing.

```python
cursor = conn.cursor()
cursor.execute("SELECT name FROM sqlite_master WHERE type='table'")
print(cursor.fetchall())
cursor.execute("SELECT sql FROM sqlite_master WHERE type='table';")
#then we display our dataset
for result in cursor.fetchall():
    print(result[0])
```

Then we write out the core 

```python
#we write our cmd 
def query_climate_database(country,year_begin,year_end,month):
    cmd = \
    """
    SELECT S.NAME, S.latitude, S.longitude, C.Country,T.year,T.month,T.Temp
    FROM temperatures T
    LEFT JOIN stations S ON T.id = S.id
    LEFT JOIN countries C ON S."FIPS 10-4"= C."FIPS 10-4"
    where C.Country ='%s' and month = '%d' and year>='%d' and year<='%d'
    """%( country,month ,year_begin,year_end)
    
    df = pd.read_sql_query(cmd, conn)
    return df

conn = sqlite3.connect("temps.db") #connect temps.db
query_climate_database(country="India",year_begin=1980,year_end=2020,month=1)
```